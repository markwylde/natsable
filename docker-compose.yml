services:
  # NATS Server with TLS and authentication
  nats:
    image: nats:latest
    container_name: natsable-server
    ports:
      - "4223:4222"   # Client connections (mapped to 4223 to avoid conflicts)
      - "8223:8222"   # HTTP monitoring (mapped to 8223 to avoid conflicts)
      - "6223:6222"   # Cluster routing (if needed)
    volumes:
      - ./config/nats-server-dev.conf:/etc/nats/nats-server.conf:ro
      - ./certs:/etc/nats/certs:ro
      - nats-data:/data
      - nats-logs:/var/log/nats
    command: ["-c", "/etc/nats/nats-server.conf"]
    healthcheck:
      test: ["CMD", "nats-server", "--help"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - natsable-network

  # Natsable Web UI
  natsable:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: natsable
    ports:
      - "3000:3000"
    environment:
      - NATS_URL=nats:4222
      - NATS_MONITORING_URL=http://nats:8222
      - CERTS_DIR=/app/certs
      - CONFIG_DIR=/app/config
      - NODE_ENV=production
    volumes:
      - ./certs:/app/certs:ro
      - ./config:/app/config:ro
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - natsable-network

volumes:
  nats-data:
    name: natsable-data
  nats-logs:
    name: natsable-logs

networks:
  natsable-network:
    name: natsable-network
    driver: bridge
